<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>Blog - Đông Dev</title>
  <meta name="description" content="Blog về lập trình, web development và công nghệ">
  <link rel="icon" href="../assets/favicon.png" type="image/png">
  
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Highlight.js for code syntax -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="../js/security.js"></script>
  
  <style>
    :root {
      --bg-dark: #0a0a14;
      --bg-darker: #050510;
      --bg-card: rgba(255, 255, 255, 0.04);
      --text-primary: #f5f5ff;
      --text-secondary: rgba(245, 245, 255, 0.75);
      --text-muted: rgba(245, 245, 255, 0.5);
      --neon-pink: #ff2d75;
      --neon-purple: #b14aed;
      --neon-blue: #00b4ff;
      --neon-cyan: #00ffea;
      --iris-purple: #a78bfa;
      --iris-cyan: #2dd4bf;
      --gradient-primary: linear-gradient(135deg, #ff2d75 0%, #b14aed 30%, #00b4ff 60%, #00ffea 100%);
      --font-heading: 'DM Sans', sans-serif;
      --font-body: 'DM Sans', sans-serif;
      --font-mono: 'Fira Code', monospace;
      --radius: 20px;
      --radius-sm: 12px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-body);
      background: var(--bg-dark);
      color: var(--text-primary);
      line-height: 1.8;
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    img { max-width: 100%; height: auto; }
    .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }

    /* Background */
    .mesh-bg {
      position: fixed; inset: 0; z-index: 0;
      background: linear-gradient(135deg, #0a0a14 0%, #0f0f1a 50%, #050510 100%);
    }
    .mesh-bg::before {
      content: ''; position: absolute; inset: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(177, 74, 237, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(0, 180, 255, 0.06) 0%, transparent 50%);
    }

    /* Header */
    .blog-header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      background: rgba(10, 10, 20, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      padding: 16px 0;
    }
    .blog-header .container {
      display: flex; align-items: center; justify-content: space-between;
      max-width: 1200px;
    }
    .back-link {
      display: flex; align-items: center; gap: 8px;
      color: var(--text-secondary); font-weight: 500;
      transition: color 0.3s;
    }
    .back-link:hover { color: var(--neon-cyan); }
    .logo {
      font-family: var(--font-heading); font-size: 1.3rem; font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    /* Article */
    .article-wrapper {
      position: relative; z-index: 1;
      padding: 120px 0 80px;
    }
    .article-header {
      text-align: center; margin-bottom: 48px;
    }
    .article-category {
      display: inline-block; padding: 6px 16px;
      background: rgba(177, 74, 237, 0.15);
      border: 1px solid rgba(177, 74, 237, 0.3);
      border-radius: 100px; font-size: 0.8rem; font-weight: 600;
      color: var(--iris-purple); text-transform: uppercase;
      margin-bottom: 20px;
    }
    .article-title {
      font-family: var(--font-heading);
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800; line-height: 1.2;
      margin-bottom: 24px;
    }
    .article-meta {
      display: flex; align-items: center; justify-content: center;
      gap: 24px; flex-wrap: wrap;
      color: var(--text-muted); font-size: 0.9rem;
    }
    .article-meta span { display: flex; align-items: center; gap: 8px; }
    .article-meta i { color: var(--iris-purple); }
    .author-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.1);
      object-fit: cover; object-position: center 20%; /* Focus khuôn mặt */
    }

    /* Featured Image */
    .article-image {
      width: 100%; aspect-ratio: 16/9;
      border-radius: var(--radius);
      overflow: hidden; margin-bottom: 48px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }
    .article-image img {
      width: 100%; height: 100%; object-fit: cover; object-position: center center;
    }
    /* Ảnh có người - focus phần trên */
    .article-image.has-person img { object-position: center 25%; }
    .article-image.has-face img { object-position: center 15%; }
    
    /* Image Focus Utilities */
    .img-focus-face { object-position: center 20% !important; }
    .img-focus-top { object-position: center top !important; }
    .img-focus-center { object-position: center center !important; }
    .img-focus-portrait { object-position: center 30% !important; }

    /* Content */
    .article-content {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius);
      padding: 48px;
    }
    .article-content h2 {
      font-family: var(--font-heading);
      font-size: 1.8rem; font-weight: 700;
      margin: 40px 0 20px;
      color: var(--text-primary);
    }
    .article-content h2:first-child { margin-top: 0; }
    .article-content h3 {
      font-size: 1.3rem; font-weight: 600;
      margin: 32px 0 16px;
      color: var(--iris-cyan);
    }
    .article-content p {
      margin-bottom: 20px;
      color: var(--text-secondary);
    }
    .article-content ul, .article-content ol {
      margin: 16px 0 24px 24px;
      color: var(--text-secondary);
    }
    .article-content li { margin-bottom: 8px; }
    .article-content strong { color: var(--text-primary); }
    .article-content a {
      color: var(--neon-cyan);
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .article-content a:hover { color: var(--neon-pink); }

    /* Code blocks */
    .article-content pre {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin: 24px 0;
      overflow-x: auto;
    }
    .article-content code {
      font-family: var(--font-mono);
      font-size: 0.9rem;
    }
    .article-content p code {
      background: rgba(177, 74, 237, 0.15);
      padding: 2px 8px;
      border-radius: 4px;
      color: var(--iris-purple);
    }

    /* Tags */
    .article-tags {
      display: flex; flex-wrap: wrap; gap: 10px;
      margin-top: 40px; padding-top: 32px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }
    .tag {
      padding: 8px 16px;
      background: rgba(0, 180, 255, 0.1);
      border: 1px solid rgba(0, 180, 255, 0.2);
      border-radius: 100px;
      font-size: 0.85rem; color: var(--iris-cyan);
    }

    /* Share */
    .article-share {
      display: flex; align-items: center; gap: 16px;
      margin-top: 24px;
    }
    .article-share span { color: var(--text-muted); font-size: 0.9rem; }
    .share-btn {
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      transition: all 0.3s;
    }
    .share-btn:hover {
      background: rgba(177, 74, 237, 0.15);
      border-color: var(--iris-purple);
      color: var(--text-primary);
    }

    /* Related Posts */
    .related-section {
      margin-top: 80px;
    }
    .related-title {
      font-family: var(--font-heading);
      font-size: 1.5rem; font-weight: 700;
      margin-bottom: 32px;
    }
    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }
    .related-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius);
      overflow: hidden;
      transition: all 0.3s;
    }
    .related-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 255, 255, 0.15);
    }
    .related-card img {
      width: 100%; aspect-ratio: 16/9; object-fit: cover; object-position: center center;
    }
    .related-card.has-person img { object-position: center 25%; }
    .related-card.has-face img { object-position: center 15%; }
    .related-card-content {
      padding: 20px;
    }
    .related-card h4 {
      font-size: 1rem; font-weight: 600;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .related-card p {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Footer */
    .blog-footer {
      text-align: center;
      padding: 40px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      margin-top: 80px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Loading */
    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 400px;
      color: var(--text-muted);
    }
    .loading i { font-size: 2rem; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .article-content { padding: 24px; }
      .article-meta { gap: 16px; }
    }
  </style>
</head>
<body>
  <div class="mesh-bg"></div>

  <header class="blog-header">
    <div class="container">
      <a href="../index.html#blog" class="back-link">
        <i class="fa-solid fa-arrow-left"></i> Quay lại
      </a>
      <a href="../index.html" class="logo">ĐÔNG.</a>
    </div>
  </header>

  <main class="article-wrapper">
    <div class="container">
      <article id="article">
        <div class="loading">
          <i class="fa-solid fa-spinner"></i>
        </div>
      </article>
    </div>
  </main>

  <footer class="blog-footer">
    <div class="container">
      <p>© 2025 Đông Dev. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="../js/security.js"></script>
  <script type="module">
    // Get post ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');

    // Helper functions
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('vi-VN', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    // Load and render post
    async function loadPost() {
      try {
        // Try Firebase first
        let posts = null;
        try {
          const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
          const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
          
          const firebaseConfig = {
            apiKey: "AIzaSyDCls_5XeIw5LbAP7wsjcaffeG6_1sCAzY",
            authDomain: "dbblogdev.firebaseapp.com",
            databaseURL: "https://dbblogdev-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dbblogdev"
          };
          
          let app = getApps()[0];
          if (!app) app = initializeApp(firebaseConfig);
          const database = getDatabase(app);
          
          const snapshot = await get(ref(database, 'posts'));
          if (snapshot.exists()) {
            const data = snapshot.val();
            posts = Object.values(data).sort((a, b) => new Date(b.date) - new Date(a.date));
            console.log('Posts loaded from Firebase:', posts.length);
          }
        } catch (fbErr) {
          console.warn('Firebase error:', fbErr);
        }
        
        // Fallback to local JSON
        if (!posts || posts.length === 0) {
          const response = await fetch('posts.json');
          const data = await response.json();
          posts = data.posts;
          console.log('Posts loaded from local JSON:', posts.length);
        }
        
        const post = posts.find(p => p.id === postId);

        if (!post) {
          document.getElementById('article').innerHTML = `
            <div class="article-header">
              <h1 class="article-title">Bài viết không tồn tại</h1>
              <p style="color: var(--text-muted);">Bài viết bạn tìm kiếm không tồn tại hoặc đã bị xóa.</p>
              <a href="../index.html#blog" style="color: var(--neon-cyan); margin-top: 20px; display: inline-block;">
                ← Quay lại trang chủ
              </a>
            </div>
          `;
          return;
        }

        // Update page title
        document.title = `${post.title} - Đông Dev`;

        // Get related posts (same category, exclude current)
        const relatedPosts = posts
          .filter(p => p.id !== post.id)
          .slice(0, 3);

        // Render article with content
        const contentHtml = marked.parse(post.content || '');
        
        document.getElementById('article').innerHTML = `
          <header class="article-header">
            <span class="article-category">${escapeHtml(post.category)}</span>
            <h1 class="article-title">${escapeHtml(post.title)}</h1>
            <div class="article-meta">
              <span>
                <img src="../assets/avatar.jpg" alt="${escapeHtml(post.author)}" class="author-avatar">
                ${escapeHtml(post.author)}
              </span>
              <span><i class="fa-regular fa-calendar"></i> ${formatDate(post.date)}</span>
              <span><i class="fa-regular fa-clock"></i> ${post.readTime} phút đọc</span>
            </div>
          </header>

          <div class="article-image">
            <img src="${post.image}" alt="${escapeHtml(post.title)}">
          </div>

          <div class="article-content">
            ${contentHtml}
            
            <div class="article-tags">
              ${post.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
            </div>

            <div class="article-share">
              <span>Chia sẻ:</span>
              <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}" 
                 target="_blank" class="share-btn" aria-label="Share on Facebook">
                <i class="fa-brands fa-facebook-f"></i>
              </a>
              <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(post.title)}" 
                 target="_blank" class="share-btn" aria-label="Share on Twitter">
                <i class="fa-brands fa-x-twitter"></i>
              </a>
              <a href="https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(window.location.href)}&title=${encodeURIComponent(post.title)}" 
                 target="_blank" class="share-btn" aria-label="Share on LinkedIn">
                <i class="fa-brands fa-linkedin-in"></i>
              </a>
            </div>
          </div>

          ${relatedPosts.length > 0 ? `
            <section class="related-section">
              <h3 class="related-title">Bài viết liên quan</h3>
              <div class="related-grid">
                ${relatedPosts.map(p => `
                  <a href="post.html?id=${p.id}" class="related-card">
                    <img src="${p.image}" alt="${p.title}">
                    <div class="related-card-content">
                      <h4>${p.title}</h4>
                      <p>${p.readTime} phút đọc</p>
                    </div>
                  </a>
                `).join('')}
              </div>
            </section>
          ` : ''}
        `;

        // Highlight code blocks
        document.querySelectorAll('pre code').forEach(block => {
          hljs.highlightElement(block);
        });

      } catch (error) {
        console.error('Error loading post:', error);
        document.getElementById('article').innerHTML = `
          <div class="article-header">
            <h1 class="article-title">Lỗi tải bài viết</h1>
            <p style="color: var(--text-muted);">Đã xảy ra lỗi khi tải bài viết. Vui lòng thử lại sau.</p>
          </div>
        `;
      }
    }

    loadPost();
  </script>
</body>
</html>
