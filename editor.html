<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Projects Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0b0f1a; --card:#0f172a; --muted:#9fb0c7; --border:#334155; --accent:#00ffa3; --danger:#ef4444; }
    *{ box-sizing:border-box }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: Inter, system-ui, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1000px 500px at 20% 10%, rgba(0,255,163,.08), transparent 60%),
                  radial-gradient(900px 520px at 80% 0%, rgba(59,130,246,.10), transparent 60%),
                  linear-gradient(135deg,#0b0f1a,#1e293b);
      color:#e5e7eb;
    }
    .wrap{
      width:min(980px, 92vw);
      background:var(--card); border:1px solid var(--border); border-radius:18px;
      box-shadow:0 14px 38px rgba(0,0,0,.45);
      padding:18px;
      display:grid; gap:18px;
      grid-template-columns: 1fr 1fr;
      transform:translateY(0); transition:transform .2s ease, box-shadow .2s ease;
    }
    .wrap:hover{ transform:translateY(-3px); box-shadow:0 18px 44px rgba(0,255,163,.22) }
    h2{ margin:0 0 12px; font-weight:900; letter-spacing:.2px; text-align:center; color:var(--accent); text-shadow:0 0 10px rgba(0,255,163,.35) }
    .card{ background:#101a2d; border:1px solid var(--border); border-radius:14px; padding:16px }
    label{ display:block; font-size:.9rem; color:var(--muted); margin:10px 0 6px }
    input, textarea{
      width:100%; background:#162338; color:#e5e7eb; border:1px solid var(--border); border-radius:10px;
      padding:10px; font-size:.95rem; outline:none; transition:border-color .2s, box-shadow .2s;
    }
    input:focus, textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,255,163,.2) }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.55rem;
      padding:11px 14px; border-radius:12px; font-weight:800; border:1px solid transparent; cursor:pointer;
      transition:transform .18s, filter .18s, box-shadow .18s, border-color .18s;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn-primary{ background:var(--accent); color:#0b1120; box-shadow:0 8px 22px rgba(0,255,163,.30) }
    .btn-primary:hover{ transform:translateY(-2px); filter:brightness(1.05); box-shadow:0 12px 30px rgba(0,255,163,.45) }
    .btn-ghost{ background:transparent; color:#cfe5ff; border:1px solid rgba(207,229,255,.25) }
    .btn-ghost:hover{ color:var(--accent); border-color:var(--accent); transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,255,163,.25) }
    .btn-danger{ background:transparent; color:#fecaca; border:1px solid rgba(239,68,68,.45) }
    .btn-danger:hover{ color:#fff; border-color:#ef4444; transform:translateY(-2px); box-shadow:0 10px 22px rgba(239,68,68,.28) }
    .muted{ color:var(--muted); font-size:.9rem }
    .list{ display:grid; gap:8px; max-height:420px; overflow:auto; padding-right:4px }
    .item{
      display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--border);
      border-radius:10px; background:#0f1a2d; transition:border-color .2s, transform .18s;
    }
    .item:hover{ border-color:rgba(0,255,163,.35); transform:translateY(-1px) }
    .title{ font-weight:800; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }
    .pill{ font-size:.75rem; padding:.2rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:#cbd5e1 }
    .toolbar{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:10px }
    .sep{ height:1px; background:var(--border); margin:10px 0 }
    .topbar{ grid-column:1/-1; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; align-items:center }
    .right{ display:flex; gap:8px; align-items:center }
    .small{ font-size:.85rem }
    .apiin{ width:230px }
    .tokin{ width:200px }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- TopBar -->
    <div class="topbar">
      <h2>Projects Editor</h2>
      <div class="right small">
        <span class="muted">API</span><input id="api" class="apiin" type="text" value="http://localhost:3001">
        <span class="muted">Token</span><input id="tok" class="tokin" type="password" value="changeme-dev-only">
        <button id="btnLoad" class="btn btn-ghost">Load</button>
        <button id="btnSaveAll" class="btn btn-ghost">Save All (from list)</button>
      </div>
    </div>
<span class="muted">Web B URL</span>
<input id="webb" class="apiin" type="text" value="http://127.0.0.1:5500/index.html">
<button id="btnImport" class="btn btn-ghost">Import from Web B</button>

    <!-- LEFT: Add/Update one project -->
    <div class="card">
      <div class="muted">Th√™m 1 project (append v√†o danh s√°ch hi·ªán c√≥)</div>
      <label>Ti√™u ƒë·ªÅ</label><input id="title" placeholder="V√≠ d·ª•: Modern Portfolio" />
      <label>M√¥ t·∫£</label><textarea id="desc" rows="3" placeholder="M√¥ t·∫£ ng·∫Øn..."></textarea>
      <label>·∫¢nh (URL ho·∫∑c assets/...)</label><input id="img" placeholder="assets/project1.jpg" />
      <div class="row2">
        <div>
          <label>Tags (ph√¢n t√°ch b·∫±ng d·∫•u ph·∫©y)</label><input id="tags" placeholder="HTML,Tailwind,AOS" />
        </div>
        <div>
          <label>Delay AOS (ms)</label><input id="delay" type="number" min="0" step="25" value="0" />
        </div>
      </div>
      <div class="row2">
        <div>
          <label>Live Link</label><input id="live" placeholder="#" />
        </div>
        <div>
          <label>GitHub Link</label><input id="git" placeholder="#" />
        </div>
      </div>
      <button id="btnAdd" class="btn btn-primary" style="margin-top:14px">üíæ Add Project</button>
    </div>

    <!-- RIGHT: Current Projects + Delete -->
    <div class="card">
      <div class="muted">Current Projects (ch·ªçn ƒë·ªÉ xo√°)</div>
      <div id="projectsList" class="list"></div>
      <div class="toolbar">
        <div class="actions">
          <button id="btnSelectAll" class="btn btn-ghost">Select All</button>
          <button id="btnClearSel" class="btn btn-ghost">Clear</button>
        </div>
        <button id="btnDelete" class="btn btn-danger">üóëÔ∏è Delete Selected</button>
      </div>
      <div class="sep"></div>
      <div class="muted small">Tip: B·∫•m <b>Load</b> ƒë·ªÉ n·∫°p d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ API. Sau khi x√≥a, h·ªá th·ªëng s·∫Ω t·ª± <b>Save</b> v√† l√†m m·ªõi danh s√°ch.</div>
    </div>
  </div>

  <script>
    // ========= Helpers =========
    const $ = sel => document.querySelector(sel);
    const apiInput = $('#api'), tokInput = $('#tok');
    const listEl = $('#projectsList');

    let rawHTML = "";       // string HTML hi·ªán l∆∞u tr√™n API
    let domRoot = null;     // div ch·ª©a rawHTML parse th√†nh DOM (ƒë·ªÉ thao t√°c)
    let articleNodes = [];  // NodeList -> Array c√°c <article> hi·ªán t·∫°i

    function buildProjectHTML({title, desc, img, tags, live, git, delay}){
      const tagsHTML = (tags || "")
        .split(',')
        .map(t => t.trim())
        .filter(Boolean)
        .map(t => `<span class="tag-neon">${t}</span>`)
        .join('');
      const delayAttr = Number(delay) > 0 ? ` data-aos-delay="${Number(delay)}"` : '';
      return `
<article class="card-neo overflow-hidden" data-aos="fade-up"${delayAttr}>
  <div class="media"><img src="${img||''}" alt="${title||''}"></div>
  <div class="p-5 grid gap-3">
    <h3 class="font-extrabold text-white text-lg">${title||''}</h3>
    <p class="text-[var(--muted)] text-sm">${desc||''}</p>
    <div class="flex flex-wrap gap-2">${tagsHTML}</div>
    <div class="flex gap-2 pt-1">
      <a class="btn-neon-ghost" href="${live||'#'}">Live</a>
      <a class="btn-neon-ghost" href="${git||'#'}">GitHub</a>
    </div>
  </div>
</article>`;
    }

    // T·∫°o DOM t·∫°m t·ª´ rawHTML
    function parseDOM(html){
      const tmp = document.createElement('div');
      tmp.innerHTML = html || "";
      return tmp;
    }

    // L·∫•y danh s√°ch <article> hi·ªán c√≥
    function getArticles(root){
  // n·∫øu c√≥ section#projects th√¨ t√¨m trong ƒë√≥
  const sec = root.querySelector('#projects');
  const scope = sec ? sec : root;
  return Array.from(scope.querySelectorAll('article'));
}

    // Sanitize text to prevent XSS
    function sanitize(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Render danh s√°ch article ra panel ph·∫£i
    function renderList(){
      articleNodes = getArticles(domRoot);
      if (articleNodes.length === 0){
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'muted';
        emptyDiv.textContent = 'Ch∆∞a c√≥ project n√†o.';
        listEl.innerHTML = '';
        listEl.appendChild(emptyDiv);
        return;
      }
      listEl.innerHTML = "";
      articleNodes.forEach((node, idx) => {
        const title = node.querySelector('h3')?.textContent?.trim() || `Project #${idx+1}`;
        const delay = node.getAttribute('data-aos-delay') || '0';
        const li = document.createElement('div');
        li.className = 'item';

        // Create elements safely without innerHTML
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.dataset.idx = idx;

        const contentDiv = document.createElement('div');
        contentDiv.style.flex = '1';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'title';
        titleDiv.textContent = title; // Safe from XSS

        const metaDiv = document.createElement('div');
        metaDiv.className = 'muted small';
        metaDiv.textContent = `Index: ${idx} ‚Ä¢ AOS delay: ${delay}ms`;

        contentDiv.appendChild(titleDiv);
        contentDiv.appendChild(metaDiv);

        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = 'article';

        li.appendChild(checkbox);
        li.appendChild(contentDiv);
        li.appendChild(pill);
        listEl.appendChild(li);
      });
    }

    // Loading state management
    let isLoading = false;
    function setLoading(loading) {
      isLoading = loading;
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = loading);
    }

    // G·ªçi API l·∫•y HTML hi·ªán t·∫°i
    async function loadFromAPI(){
      if (isLoading) return;
      setLoading(true);

      try {
        const url = apiInput.value.replace(/\/$/,'') + '/api/sections/projects';
        const r = await fetch(url, { cache:'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);

        const j = await r.json();
        rawHTML = (j && j.ok && typeof j.html === 'string') ? j.html : "";
        domRoot = parseDOM(rawHTML);
        renderList();
        alert('‚úÖ Loaded from API!');
      } catch(e) {
        alert('‚ùå Load failed: ' + e.message);
      } finally {
        setLoading(false);
      }
    }

    // Ghi rawHTML m·ªõi l√™n API
    async function saveToAPI(newHTML){
      const url = apiInput.value.replace(/\/$/,'') + '/api/sections/projects';
      const r = await fetch(url, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + tokInput.value
        },
        body: JSON.stringify({ html:newHTML })
      });
      const j = await r.json();
      if (!j || !j.ok) throw new Error(j?.error || 'save_failed');
      return j;
    }

    // ========= Events =========
    $('#btnLoad').addEventListener('click', loadFromAPI);

    // Add 1 project (append to grid n·∫øu c√≥; n·∫øu kh√¥ng, append cu·ªëi raw HTML)
    $('#btnAdd').addEventListener('click', async ()=>{
      if (isLoading) return;
      setLoading(true);

      try {
        // l·∫•y d·ªØ li·ªáu t·ª´ form
        const data = {
          title: $('#title').value.trim(),
          desc:  $('#desc').value.trim(),
          img:   $('#img').value.trim(),
          tags:  $('#tags').value.trim(),
          live:  $('#live').value.trim(),
          git:   $('#git').value.trim(),
          delay: $('#delay').value.trim()
        };

        if (!data.title) {
          alert('‚ö†Ô∏è Title is required');
          return;
        }

        const article = buildProjectHTML(data);

        // ƒë·∫£m b·∫£o ƒë√£ load
        if (!domRoot) { domRoot = parseDOM(rawHTML); }

        // ∆∞u ti√™n ch√®n v√†o grid hi·ªán c√≥; n·∫øu kh√¥ng c√≥ grid, append v√†o cu·ªëi
        const grid = domRoot.querySelector('.grid') || domRoot;
        const holder = document.createElement('div');
        holder.innerHTML = article;
        grid.appendChild(holder.firstElementChild);

        const newHTML = domRoot.innerHTML;
        await saveToAPI(newHTML);
        rawHTML = newHTML;
        renderList();
        alert('‚úÖ Added & Saved!');

        // Clear form
        $('#title').value = '';
        $('#desc').value = '';
        $('#img').value = '';
        $('#tags').value = '';
        $('#live').value = '';
        $('#git').value = '';
        $('#delay').value = '0';
      }catch(e){
        alert('‚ùå Save error: ' + e.message);
      } finally {
        setLoading(false);
      }
    });

    // Select All / Clear
    $('#btnSelectAll').addEventListener('click', ()=>{
      listEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    });
    $('#btnClearSel').addEventListener('click', ()=>{
      listEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });

    // Delete selected articles
    $('#btnDelete').addEventListener('click', async ()=>{
      if (isLoading) return;
      if (!domRoot) { alert('Ch∆∞a load d·ªØ li·ªáu. B·∫•m Load tr∆∞·ªõc.'); return; }

      const selected = Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(cb => parseInt(cb.dataset.idx,10))
                            .filter(n => !Number.isNaN(n));
      if (selected.length === 0){ alert('Ch∆∞a ch·ªçn project ƒë·ªÉ xo√°.'); return; }
      if (!confirm(`Xo√° ${selected.length} project ƒë√£ ch·ªçn?`)) return;

      setLoading(true);
      try {
        // xo√° theo index gi·∫£m d·∫ßn ƒë·ªÉ kh√¥ng l·ªách index
        const arts = getArticles(domRoot);
        selected.sort((a,b)=>b-a).forEach(i => {
          const node = arts[i];
          if (node && node.parentNode) node.parentNode.removeChild(node);
        });

        const newHTML = domRoot.innerHTML;
        await saveToAPI(newHTML);
        rawHTML = newHTML;
        renderList();
        alert('üóëÔ∏è ƒê√£ xo√° & l∆∞u th√†nh c√¥ng!');
      }catch(e){
        alert('‚ùå Save error: ' + e.message);
      } finally {
        setLoading(false);
      }
    });

    // Save All (n·∫øu anh ch·ªânh s·ª≠a danh s√°ch b·∫±ng code kh√°c trong t∆∞∆°ng lai)
    $('#btnSaveAll').addEventListener('click', async ()=>{
      if (isLoading) return;
      if (!domRoot){ alert('Ch∆∞a load d·ªØ li·ªáu.'); return; }

      setLoading(true);
      try{
        await saveToAPI(domRoot.innerHTML);
        alert('‚úÖ Saved current DOM to API!');
      }catch(e){
        alert('‚ùå Save error: ' + e.message);
      } finally {
        setLoading(false);
      }
    });

    // T·ª± load 1 l·∫ßn khi m·ªü trang
    loadFromAPI().catch(()=>{ /* im l·∫∑ng n·∫øu API ch∆∞a ch·∫°y */ });
 async function importFromWebB() {
  if (isLoading) return;

  const apiBase = document.querySelector('#api')?.value?.replace(/\/$/, '');
  const pageUrl = document.querySelector('#webb')?.value?.trim();
  if (!apiBase) { alert('Thi·∫øu API base.'); return; }
  if (!pageUrl) { alert('Nh·∫≠p Web B URL tr∆∞·ªõc.'); return; }

  setLoading(true);
  const proxyUrl = `${apiBase}/api/proxy/fetch?url=${encodeURIComponent(pageUrl)}`;
  const mode = "all"; // "all" = l·∫•y to√†n b·ªô content #projects

  try {
    console.log('[IMPORT] fetch proxy:', proxyUrl);
    const resp = await fetch(proxyUrl, { cache: 'no-store' });
    if (!resp.ok) {
      const msg = `Proxy failed: ${resp.status} ${resp.statusText}`;
      console.error(msg);
      alert('‚ùå ' + msg + ' ‚Äì Th∆∞·ªùng do URL sai, 404 ho·∫∑c host ch∆∞a whitelist.');
      return;
    }
    const htmlText = await resp.text();
    if (!htmlText || !htmlText.trim()) {
      alert('‚ùå Proxy tr·∫£ v·ªÅ r·ªóng. Ki·ªÉm URL Pages.');
      return;
    }

    // Parse & l·∫•y #projects
    const tmp = document.createElement('div');
    tmp.innerHTML = htmlText;
    const sec = tmp.querySelector('#projects');
    if (!sec) {
      console.error('Kh√¥ng t√¨m th·∫•y #projects trong HTML t·∫£i v·ªÅ');
      alert('‚ùå Kh√¥ng t√¨m th·∫•y <section id="projects"> tr√™n trang Web B.');
      return;
    }

    const newHTML = (mode === 'all')
      ? sec.innerHTML
      : Array.from(sec.querySelectorAll('article')).map(a => a.outerHTML).join('\n');

    if (!newHTML.trim()) {
      alert('‚ùå N·ªôi dung #projects r·ªóng (kh√¥ng c√≥ article).');
      return;
    }

    // Save
    const saveUrl = `${apiBase}/api/sections/projects`;
    console.log('[IMPORT] save to:', saveUrl);
    const r = await fetch(saveUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + (document.querySelector('#tok')?.value || '')
      },
      body: JSON.stringify({ html: newHTML })
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok || !j?.ok) {
      console.error('Save failed:', r.status, j);
      alert('‚ùå Save failed: ' + (j?.error || r.status));
      return;
    }

    // C·∫≠p nh·∫≠t UI
    rawHTML = newHTML;
    domRoot = parseDOM(newHTML);
    renderList();

    alert('‚úÖ Imported & saved!');
  } catch (e) {
    console.error(e);
    alert('‚ùå Import error: ' + e.message);
  } finally {
    setLoading(false);
  }
}
document.querySelector('#btnImport')?.addEventListener('click', importFromWebB);
  </script>
</body>
</html>
